name: backport.yml
on:
    #pull_request:
    #  types: [ closed, labeled ]
    pull_request_target:
      types: [ labeled, closed ]

jobs:
  backport:
    name: Backport
    runs-on: ubuntu-latest
    # Only react to merged PRs for security reasons.
    # See https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request_target.
#    if: >
#      github.event.pull_request.merged
#      && (
#        github.event.action == 'closed'
#        || (
#          github.event.action == 'labeled'
#          && contains(github.event.label.name, 'backport')
#        )
#      )
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Fetch PR branch
        run: |
          git fetch origin main
          git fetch origin pull/${{ github.event.pull_request.number }}/head:backport
          COMMITS=$(git log --format="%H" main..backport)
          echo "$COMMITS"
          echo "$COMMITS" > commits.txt

      # api call for merge commit sha insted



      ## GH token/ app token/PAT
      # gh api or gh cli
      - name: Cherry-pick to backport branch
        run: |
          git config user.name "adela-domokosova"
          git config user.email "adela.domokosova@gmail.com"
          git checkout prod
          
          failed=0
          
          while read -r line; do
            git cherry-pick "$line" || {
            echo "Conflict"
            git cherry-pick --abort
            failed=1
            break
            }
          done <commits.txt

          if [ "$failed" -eq 1 ]; then
            echo "Fail, comment"
            curl -s -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"body\":\"Cannot cherry-pick due to merge conflict.\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
            exit 1
          else
            echo "Cherry-pick OK, pushing..."
            git push origin backport/prod-${{ github.event.pull_request.number }}
            
            curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
            \"title\": \"Backport PR #${{ github.event.pull_request.number }} to prod\",
            \"head\": \"backport/prod-${{ github.event.pull_request.number }}\",
            \"base\": \"prod\",
            \"body\": \"Cherry-picked changes from #${{ github.event.pull_request.number }} to \`prod\`.\"
          }" \
            https://api.github.com/repos/${{ github.repository }}/pulls
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}